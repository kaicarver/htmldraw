<!DOCTYPE html>
<html lang="en">
<head>
<title>Multitouch Paint</title>
<meta charset="UTF-8">
<script src="jquery-1.9.1.min.js"></script>
<style media="screen">
  .drawarea {
    border: 1px solid #ccc;
  }
  .drawarea_background {
    position: relative;
    top: -100px;
    z-index: -1;
    font-size: 8em;
    opacity: 0.5;
    background-color: white;
    font-family: KaiTi, "楷体", SimKai, serif;
  }
  #saveimg { width: 3em; height: 1.2em; border: 1px solid gray; vertical-align: middle; display: none; }
</style>
</head>
<body>
<div id="content">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<h2>Multitouch Paint</h2>
<p>
<span>
<button id="b1" class="lineWidth">1</button>
<button id="b2" class="lineWidth">2</button>
<button id="b5" class="lineWidth">5</button>
<button id="b10" class="lineWidth">10</button>
<button id="b15" class="lineWidth">15</button>
<button id="b25" class="lineWidth">25</button>
<button id="b50" class="lineWidth">50</button>
<button id="b100" class="lineWidth">100</button>
</span>
<span>
<button id="c_black" class="lineColor">black</button>
<button id="c_white" class="lineColor">white</button>
<button id="c_blue"  class="lineColor">blue</button>
<button id="c_red"   class="lineColor">red</button>
<button id="c_green" class="lineColor">green</button>
<button id="c_rand"  class="lineColor">random color</button>
</span>
<span>
<button id="clearCanvas">clear</button>
<button id="saveCanvas">save</button>
</span>
<img id="saveimg" src="">
</p>

<canvas id="example" class="drawarea" height="400"></canvas>
<div id="example_background" class="drawarea_background">
  台北市大同區敦煌路八十巷一號三樓之二
</div>
<p id="simulate">
  To toggle simulating touch with mouse, press Esc key. For multi-touch, hold down Alt key, or Alt and Shift keys.
  <!--<a href="javascript:void(handleTouch())">Simulate Touch</a>-->
</p>
<p>
  Based on <a href="http://www.paulirish.com/demo/multi">http://www.paulirish.com/demo/multi</a><br/>
  Touch simulation from <a href="https://github.com/brian-c/phantom-limb">https://github.com/brian-c/phantom-limb</a>
</p>
<script>
var CanvasDrawr = function (options) {
  //console.log(options);
  var canvas = document.getElementById(options.id);
  var canvas_background = document.getElementById(options.id + '_background');
  this.ctxt = canvas.getContext("2d");
  var ctxt = this.ctxt;
  this.lineWidth = function(width) { ctxt.lineWidth = width; return ctxt.lineWidth; }
  this.lineColor = function(color) { ctxt.lineColor = color; return ctxt.lineColor; }
  this.clear = function() { ctxt.clearRect(0, 0, canvas.width, canvas.height); }
  canvas.style.width = '100%';
  canvas.width = canvas.offsetWidth;
  canvas.style.width = '';
  canvas.style.height = '300px';
  canvas.height = canvas.offsetHeight;
  canvas.style.height = '';
  canvas_background.style.top = '-300px';
  ctxt.lineWidth = options.lineWidth || Math.ceil(Math.random() * 35);
  ctxt.lineCap = options.lineCap || "round";
  ctxt.lineColor = options.lineColor || "black";
  ctxt.pX = undefined;
  ctxt.pY = undefined;
  var lines = [, , ];
  var offset = $(canvas).offset();
  var self = {
    init: function () {
      canvas.addEventListener('touchstart', self.preDraw, false);
      canvas.addEventListener('touchmove', self.draw, false);
    },
    preDraw: function (event) {
      $.each(event.touches, function (i, touch) {
        var id = touch.identifier,
	    colors = ["red", "green", "yellow", "blue", "magenta", "orangered"],
	    mycolor = colors[Math.floor(Math.random() * colors.length)];
	if (ctxt.lineColor!="random color") { mycolor = ctxt.lineColor; }
        lines[id] = {
          x: this.pageX - offset.left,
          y: this.pageY - offset.top,
          color: mycolor
        };
      });
      event.preventDefault();
    },
    draw: function (event) {
      var e = event,
        hmm = {};
      $.each(event.touches, function (i, touch) {
        var id = touch.identifier,
          moveX = this.pageX - offset.left - lines[id].x,
          moveY = this.pageY - offset.top - lines[id].y;
        var ret = self.move(id, moveX, moveY);
        lines[id].x = ret.x;
        lines[id].y = ret.y;
      });
      event.preventDefault();
    },
    move: function (i, changeX, changeY) {
      ctxt.strokeStyle = lines[i].color;
      ctxt.beginPath();
      ctxt.moveTo(lines[i].x, lines[i].y);
      ctxt.lineTo(lines[i].x + changeX, lines[i].y + changeY);
      ctxt.stroke();
      ctxt.closePath();
      return {
        x: lines[i].x + changeX,
        y: lines[i].y + changeY
      };
    },
  };
  return self.init();
};
var drawarea;
window.onload = initAll;
function initAll() {
  drawarea = new CanvasDrawr({ id: "example" });
  $("button.lineWidth").bind({ click: function() { drawarea.lineWidth(this.innerText);
						   highlightButton(this);
						 } });
  $("button.lineColor").bind({ click: function() { drawarea.lineColor(this.innerText);
						   highlightButton(this);
						 } });
  $("button#clearCanvas").bind({ click: function() { drawarea.clear();
						 } });
  $("button#saveCanvas").bind({
	click: function() {
	  var img =  document.getElementById('saveimg');
	  img.src = document.getElementById('example').toDataURL('image/png');
	  img.style.display = 'inline-block';
	} });
  $('#b5').click();
  $('#c_blue').click();
  simulateTouch();
}
function simulateTouch(warnTouch) {
  if (false && warnTouch && 'ontouchstart' in document.documentElement) {
    // this is no good because my laptop handles touch but not when using an external screen, so I need both
    console.log("Your device handles touch already!")
  } else {
    // make it possible to simulate touch for mouse input using Brian Carstensen's Phantom Limb script
    var scriptTag = document.createElement('script');
    scriptTag.type = 'text/javascript';
    scriptTag.src = 'phantom-limb.js';
    document.body.appendChild(scriptTag);
  }
  //document.getElementById("simulate").style.display = "none";
  }
function highlightButton(button) {
  // presentation stuff: highlight the selected button
  var buttons = button.parentNode.children;
  for (var i = 0; i < buttons.length; i++) {
    buttons[i].style.fontWeight = '';
    buttons[i].style.backgroundColor = '';
  }
  button.style.fontWeight = "bold";
  button.style.backgroundColor = "lightgray";
}
</script>
</body>
</html>
